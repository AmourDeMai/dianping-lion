<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="OperationLog">
	<typeAlias alias="OpLog" type="com.dianping.lion.entity.OperationLog" />
	<typeAlias alias="OpLogSearch"
		type="com.dianping.lion.entity.OperationLogSearch" />
		
	<resultMap id="OperationLogResult" class="OpLog">
		<result column="id" property="id"/>
		<result column="opType" property="opType"/>
		<result column="opUserId" property="opUserId"/>
		<result column="opUserName" property="opUserName"/>
		<result column="opUserIp" property="opUserIp"/>
		<result column="envId" property="envId"/>
		<result column="envName" property="envName"/>
		<result column="opTime" property="opTime"/>
		<result column="envId" property="envId"/>
		<result column="projectId" property="projectId"/>
		<result column="projectName" property="projectName"/>
		<result column="content" property="content"/>
	</resultMap>
	
	<select id="getOpLogs" resultMap="OperationLogResult">
		<![CDATA[
		SELECT
		  T2.id,
		  opType,
		  opUserId,
		  opUserName,
		  opUserIp,
		  envId,
		  environment.name AS envName,
		  opTime,
		  projectId,
		  projectName,
		  content
		FROM (SELECT
		        T1.id,
		        opType,
		        opUserId,
		        user.name AS opUserName,
		        opUserIp,
		        envId,
		        opTime,
		        projectId,
		        projectName,
		        content
		      FROM (SELECT
		              ol.id  AS id,
		              opType,
		              opUserId,
		              opUserIp,
		              envId,
		              opTime,
		              projectId,
		              p.name  AS projectName,
		              content
		            FROM op_log AS ol
		              LEFT JOIN project AS p
		                ON ol.projectId = p.id) AS T1
		        LEFT JOIN user
		          ON T1.opUserId = user.id) AS T2
		  LEFT JOIN environment
		    ON environment.id = T2.envId
		]]>
    </select>
    <select id="getOpLogList" resultMap="OperationLogResult" parameterClass="OpLogSearch">
	    <![CDATA[
		SELECT OL.id, opType, opUserIp, opUserId, U.name as opUserName, envId, E.name envName,opTime, projectId, project.name projectName, content
		FROM op_log AS OL,
		  user AS U,
		  environment AS E,
		  project
		WHERE OL.envId = E.id
		    AND OL.opUserId = U.id
		    AND OL.projectId = project.id
		]]>
		<dynamic>
		    	<isNotEqual prepend="AND" property="project" compareValue="-1">
            		OL.projectId=#project#
        		</isNotEqual>
        		<isNotEqual prepend="AND" property="user" compareValue="-1">
            		OL.opUserId=#user#
        		</isNotEqual>
        		<isNotEqual prepend="AND" property="opType" compareValue="-1">
            		OL.opType=#opType#
        		</isNotEqual>
        		<isNotEqual prepend="AND" property="env" compareValue="-1">
            		OL.envId=#env#
        		</isNotEqual>
        		<isNotEqual prepend="AND" property="content" compareValue="">
            		content like #content#
        		</isNotEqual>
        		<isNotEmpty prepend="AND" property="from">
            		OL.opTime >= #from#
        		</isNotEmpty>
        		<isNotEmpty prepend="AND" property="to">
        			<![CDATA[
            		OL.opTime <= #to#
            		]]>
        		</isNotEmpty>
		</dynamic>
	</select>
    
</sqlMap>